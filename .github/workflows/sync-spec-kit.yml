name: Sync Spec-Kit Commands

on:
  schedule:
    # 每周一凌晨2点运行 (UTC)
    - cron: '0 2 * * 1'
  workflow_dispatch:  # 允许手动触发

jobs:
  sync-spec-kit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Git
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
      - name: Create sync branch
        run: |
          BRANCH_NAME="chore/sync-spec-kit-$(date +%Y%m%d)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b $BRANCH_NAME
          
      - name: Run spec-kit sync
        run: |
          chmod +x ./sync-spec-kit.sh
          ./sync-spec-kit.sh
          
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet HEAD -- .claude/commands/SDD/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi
          
      - name: Commit changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git add .claude/commands/SDD/
          git commit -m "chore: sync spec-kit commands - $(date +%Y-%m-%d)
          
          🔄 Automatically synced from https://github.com/github/spec-kit/tree/main/templates/commands
          
          Updated files:
          $(git diff --name-only HEAD~1 -- .claude/commands/SDD/ | sed 's/^/- /')"
          
      - name: Push branch
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git push origin ${{ env.BRANCH_NAME }}
          
      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `chore: sync spec-kit commands - ${new Date().toISOString().split('T')[0]}`,
              head: process.env.BRANCH_NAME,
              base: 'main',
              body: `## 🔄 Automated Spec-Kit Sync
              
              This PR automatically syncs the latest commands from [GitHub Spec-Kit](https://github.com/github/spec-kit/tree/main/templates/commands) to our \`.claude/commands/SDD\` directory.
              
              ### 📋 Changes
              
              - Synced commands from spec-kit templates/commands
              - Updated on: ${new Date().toISOString().split('T')[0]}
              
              ### 🔍 Review Notes
              
              Please review the changes to ensure:
              - [ ] No sensitive information was introduced
              - [ ] Command files are properly formatted
              - [ ] All commands are compatible with our setup
              
              ### 🤖 Automation
              
              This PR was created automatically by the \`sync-spec-kit.yml\` workflow.
              If everything looks good, you can merge this PR to apply the updates.
              
              ---
              
              Generated by GitHub Actions 🚀`
            });
            
            console.log(\`Created PR #\${pr.number}: \${pr.html_url}\`);
            
      - name: No changes notification
        if: steps.changes.outputs.has_changes == 'false'
        run: |
          echo "✅ Spec-kit commands are already up to date. No PR needed."